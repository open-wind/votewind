<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Open Wind Energy - Latest wind constraints</title>

<!-- ********************************************************************* -->
<!-- ********************************************************************* -->
<!-- ******** Simple HTML file to load open wind constraint layers ******* -->
<!-- ********************************************************************* -->
<!-- Based on: https://docs.mapbox.com/mapbox-gl-js/example/toggle-layers/ -->
<!-- ********************************************************************* -->
<!-- ********************************************************************* -->

<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.2.0/dist/maplibre-gl.css' />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=visibility" />
<script src='https://unpkg.com/maplibre-gl@5.2.0/dist/maplibre-gl.js'></script>
<script src="datasets-latest-style.js"></script>
<script src="bounds-centre.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<style>

    body {
        font-family: 'Open Sans', sans-serif;
    }

    #menu {
        position: absolute;
        z-index: 1;
        top: 10px;
        left: 10px;
        border-radius: 3px;
        max-width: 250px;
        text-overflow: ellipsis;
    }

    #menu a {
        font-size: 12px;
        color: #ffffff;
        display: block;
        margin: 0;
        padding: 0;
        padding: 4px 10px 4px 10px;
        text-decoration: none;
        opacity: 0.65;
        text-shadow: 1px 1px 5px rgba(0, 0, 0, 1);
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #menu a:last-child {
        border: none;
    }

    #menu a.active {
        opacity: 1;
    }

    #info {
        position: absolute;
        font-size: 12px;
        margin-left: calc((100vw - 320px)/2);;
        bottom: 60px;
        width: 300px;
        z-index: 1000;
        text-align: center;
        padding: 10px;
        background: #ffffffcf;
        border-radius: 20px;
    }

    div.spacer {
        height: 3px;
    }

    div.link_container {
        background: #fff;
        opacity: 0.9;
        border-bottom: 0.1px solid rgba(255, 255, 255, 0.114);
    }

    @media only screen and (max-width: 600px) {
        #menu {
            top: 0px;
            left: 0px;
            max-width: 120px;
        }
        #menu a {
            font-size: 8px;
            padding: 3px 4px 3px 4px;
        }
        div.spacer {
            height: 0px;
        }
    }
</style>

<div id="info">

    <div>
        <a href="#" onClick="layersHide();">Hide</a>
        <a href="#" onClick="layersShow();">Show</a>

    </div>

    <div>
        <input
            id="opacity-slider"
            type="range"
            min="0"
            max="100"
            style="position: absolute; top: 10px; left: 10px; z-index: 999;"
            />
        <label for="opacity-slider" id="opacity-label" style="position: absolute; top: 35px; left: 10px; z-index: 999;">
        </label>
    </div>

</div>
<nav id="menu"></nav>
<div id="map"></div>

<script>

    const map = new maplibregl.Map({
        container: 'map',
        style: url_tileserver_style_json,
        zoom: 12,
        center: [0, 51], 
        maxPitch: 85,
        minZoom: 5,
        maxBounds: MAPAPP_MAXBOUNDS
    });

    map.addControl(
        new maplibregl.NavigationControl({
            visualizePitch: true,
            showZoom: true,
            showCompass: true
        })
    );

    const layersHide = () => {
        for (const id of layers_all) {
            if (map.getLayer(id)) {
                map.setLayoutProperty(id, 'visibility', 'none');
            }
        }
    }

    const layersShow = () => {
        for (const id of layers_all) {
            if (map.getLayer(id)) {
                map.setLayoutProperty(id, 'visibility', 'visible');
            }
        }
    }

    const layersOpacity = (map, opacity) => {
        for (const id of layers_all) {
            const layer = map.getLayer(id);
            if (!layer) continue;

            const type = layer.type;

            if (type === 'fill') {
                const layer_opacity = id.includes('other-technical-constraints') ? (opacity / 1) : opacity; 
                map.setPaintProperty(id, 'fill-opacity', layer_opacity);
            } 
            
        }
    }

    const opacity2slider = (opacity) => {
        const factor = Math.pow(opacity, 1 / 3);
        return factor * 100;
    }

    const slider2opacity = (slider) => {
        const factor = slider / 100;
        return Math.pow(factor, 3); // 2.0 = gentle curve, 3.0 = steeper
    }

    const layer_color = 'blue';
    const layers_opacity = 0.065;
    
    // const layers_allconstraints = [
    //                             'latest--other-technical-constraints--090',
    //                             'latest--other-technical-constraints--100',
    //                             'latest--other-technical-constraints--125',
    //                             'latest--other-technical-constraints--150',
    //                             'latest--other-technical-constraints--175',
    //                             'latest--other-technical-constraints--200',
    //                             'latest--other-technical-constraints--225',
    //                             'latest--other-technical-constraints--250'
    //                         ];

    const layers_allconstraints =   [
                                    'latest--other-technical-constraints--090',
                                    'latest--other-technical-constraints--150',
                                    'latest--other-technical-constraints--250'
                                    ];

    const layers_individualconstraints =    [
                                            'latest--aviation-and-exclusion-areas',
                                            'latest--ecology-and-wildlife',
                                            'latest--heritage-impacts',
                                            'latest--inadequate-wind-speeds',
                                            'latest--landscape-and-visual-impacts',
                                            'latest--residential-buildings'
                                            ];

    const layers_all = [...layers_allconstraints, ...layers_individualconstraints];

    // Wait until map has finished loading
    map.on('load', () => {
        
        // if (MAPAPP_FITBOUNDS !== null) map.fitBounds(MAPAPP_FITBOUNDS);

        const opacitySlider = document.getElementById('opacity-slider');
        const opacityLabel = document.getElementById('opacity-label');

        opacityLabel.textContent = `Opacity: ${parseInt(opacity2slider(layers_opacity))}%`;

        opacitySlider.addEventListener('input', () => {
            const opacity = slider2opacity(opacitySlider.value);
            opacityLabel.textContent = `Opacity: ${parseInt(opacitySlider.value)}%`;
            layersOpacity(map, opacity);
        });

        for (const layer of layers_allconstraints) {
            map.addLayer({
                id: layer,
                type: 'fill',
                source: layer,
                "source-layer": "latest--other-technical-constraints",
                paint: {
                    'fill-color': layer_color,
                    'fill-opacity': (layers_opacity / 10),
                    'fill-outline-color': '#FFFFFF00'
                },
                "layout": {
                    "visibility": "visible"
                }
            });
        }


        for (const layer of layers_individualconstraints) {
            map.addLayer({
                id: layer,
                type: 'fill',
                source: layer,
                "source-layer": layer,
                paint: {
                    'fill-color': layer_color,
                    'fill-opacity': layers_opacity,
                    'fill-outline-color': '#00000000'
                },
                "layout": {
                    "visibility": "visible"
                }
            });

            // map.addLayer({
            //     id: layer + '_line',
            //     type: 'line',
            //     source: layer,
            //     "source-layer": layer,
            //     paint: {
            //         'line-color': 'black',
            //         'line-width': 0.1
            //     }
            // });

        }



        return;

        const info = document.getElementById('info');
        title_text = 'Wind constraints for turbine height to tip: <b>' + openwind_structure.tipheight + 'm</b>, blade radius: <b>' + openwind_structure.bladeradius + 'm</b>';
        if (openwind_structure.configuration != '') title_text += ' using configuration <b>' + openwind_structure.configuration + '</b>';
        info.innerHTML = title_text;

        // Iterate through openwind datasets to produce list of menu items
        const datasets = openwind_structure.datasets;
        var menu_links = [];
        for(var dataset_index = 0; dataset_index < datasets.length; dataset_index++) {
            menu_links.push(datasets[dataset_index]);
            if (datasets[dataset_index].children !== undefined) {
                const children = datasets[dataset_index].children;
                for (var children_index = 0; children_index < children.length; children_index++) {
                    menu_links.push(children[children_index]);
                }
            }
        }

        for(var menu_index = 0; menu_index < menu_links.length; menu_index++) {
            const menuitems = document.getElementById('menu');
            const openwind_dataset = menu_links[menu_index];
            const id = openwind_dataset['dataset'];

            // Add spacer
            if ((menu_index !== 0) && (openwind_dataset.level == 1)) {
                const spacer = document.createElement('div');
                spacer.className = 'spacer';
                spacer.innerHTML = ' ';
                menuitems.appendChild(spacer);
            }

            // Ad-hoc colour change to improve visibility of text
            if (openwind_dataset.color == 'chartreuse') openwind_dataset.color = '#5eb507';

            // Create link
            const link_container = document.createElement('div');
            link_container.className = 'link_container';
            const link = document.createElement('a');

            link.id = openwind_dataset['dataset'];
            link.href = '#';
            link.style.backgroundColor = openwind_dataset.color;
            link.style.fontWeight = (openwind_dataset.level == 1) ? '700': '400';
            link.innerHTML = ((openwind_dataset.level == 1) ? openwind_dataset.title : '&bull;&nbsp;' + openwind_dataset.title);
            link.className = openwind_dataset.defaultactive ? 'active' : '';

            // Show or hide layer when the toggle is clicked
            link.onclick = function (e) {
                const clickedLayer = this.id;
                e.preventDefault();
                e.stopPropagation();
                
                const visibility = map.getLayoutProperty(
                    clickedLayer,
                    'visibility'
                );

                // Toggle layer visibility by changing the layout object's visibility property
                if (visibility === 'visible') {
                    this.className = '';
                    map.setLayoutProperty(clickedLayer, 'visibility', 'none');
                } else {
                    this.className = 'active';
                    map.setLayoutProperty(
                        clickedLayer,
                        'visibility',
                        'visible'
                    );
                }
            };

            link_container.appendChild(link);
            menuitems.appendChild(link_container);
        }
    });

</script>

</body>
</html>