import{a as e}from"./chunk-3WQQGQIW.js";import{a as t}from"./chunk-OFGHX2F3.js";import{a as r}from"./chunk-I4PVU2XE.js";import{c as s,h as a}from"./chunk-4PT23TTH.js";import"./chunk-J4RA3VLE.js";import{a as n,b as i,d as o}from"./chunk-I4JBCTLR.js";import{a as l}from"./chunk-MCEXFPZL.js";import"./chunk-5IUKPU5Q.js";import"./chunk-B3NSNNUV.js";import"./chunk-BOXFFUY5.js";import"./chunk-OVZZEY7C.js";var d=Math.cos(l.toRadians(150)),f=new i,h=new n,c=new i,u=new i;function p(e){let t=8*e,s=3*t,a=4*t;this.startEllipsoidNormals=new Float32Array(s),this.endEllipsoidNormals=new Float32Array(s),this.startPositionAndHeights=new Float32Array(a),this.startFaceNormalAndVertexCornerIds=new Float32Array(a),this.endPositionAndHeights=new Float32Array(a),this.endFaceNormalAndHalfWidths=new Float32Array(a),this.vertexBatchIds=new Uint16Array(t),this.indices=r.createTypedArray(t,36*e),this.vec3Offset=0,this.vec4Offset=0,this.batchIdOffset=0,this.indexOffset=0,this.volumeStartIndex=0}var m=new n,A=new n;function w(e,t,r,s,a){let i=n.subtract(r,t,A),o=n.subtract(t,e,m);return n.normalize(i,i),n.normalize(o,o),n.dot(i,o)<d&&(o=n.multiplyByScalar(o,-1,m)),n.add(i,o,a),n.equals(a,n.ZERO)&&(a=n.subtract(e,t)),n.cross(a,s,a),n.cross(s,a,a),n.normalize(a,a),a}var b=[0,2,6,0,6,4,0,1,3,0,3,2,0,4,5,0,5,1,5,3,1,5,7,3,7,5,4,7,4,6,7,6,2,7,2,3],k=b.length,N=new n,g=new n,y=new n,F=new n,I=new n;p.prototype.addVolume=function(e,t,r,s,a,i,o,l,d,f){let h=n.add(t,d,N),c=f.geodeticSurfaceNormal(h,g);h=n.add(r,d,N);let u=f.geodeticSurfaceNormal(h,F),p=w(e,t,r,c,y),m=w(s,r,t,u,I),A=this.startEllipsoidNormals,E=this.endEllipsoidNormals,x=this.startPositionAndHeights,v=this.startFaceNormalAndVertexCornerIds,H=this.endPositionAndHeights,O=this.endFaceNormalAndHalfWidths,P=this.vertexBatchIds,U=this.batchIdOffset,V=this.vec3Offset,j=this.vec4Offset,B;for(B=0;B<8;B++)n.pack(c,A,V),n.pack(u,E,V),n.pack(t,x,j),x[j+3]=a,n.pack(r,H,j),H[j+3]=i,n.pack(p,v,j),v[j+3]=B,n.pack(m,O,j),O[j+3]=o,P[U++]=l,V+=3,j+=4;this.batchIdOffset=U,this.vec3Offset=V,this.vec4Offset=j;let S=this.indices,T=this.volumeStartIndex,C=this.indexOffset;for(B=0;B<k;B++)S[C+B]=b[B]+T;this.volumeStartIndex+=8,this.indexOffset+=k};var E=new a,x=new o,v=new n,H=new n,O=new n,P=new n,U=new n,V=e(function(e,d){let m=new Uint16Array(e.positions),A=new Uint16Array(e.widths),w=new Uint32Array(e.counts),b=new Uint16Array(e.batchIds),k=new Float64Array(e.packedBuffer),N=0,g=k[N++],y=k[N++];a.unpack(k,N,E),N+=a.packedLength,o.unpack(k,N,x),N+=o.packedLength,n.unpack(k,N,v);let F,I=m.length/3,V=m.subarray(0,I),j=m.subarray(I,2*I),B=m.subarray(2*I,3*I);t.zigZagDeltaDecode(V,j,B),function(e,t,r,s){let a=s.length,n=e.length,o=new Uint8Array(n),l=0;for(let r=0;r<a;r++){let a=s[r],n=a;for(let r=1;r<a;r++){let s=l+r,a=s-1;u.longitude=e[s],u.latitude=t[s],c.longitude=e[a],c.latitude=t[a],i.equals(u,c)&&(n--,o[a]=1)}s[r]=n,l+=a}let d=0;for(let s=0;s<n;s++)1!==o[s]&&(e[d]=e[s],t[d]=t[s],r[d]=r[s],d++)}(V,j,B,w);let S=w.length,T=0;for(F=0;F<S;F++)T+=w[F]-1;let C=new p(T),R=function(e,t,r,s,a,o,d){let c=e.length,u=new Float64Array(3*c);for(let p=0;p<c;++p){let c=e[p],m=t[p],A=r[p],w=l.lerp(s.west,s.east,c/32767),b=l.lerp(s.south,s.north,m/32767),k=l.lerp(a,o,A/32767),N=i.fromRadians(w,b,k,f),g=d.cartographicToCartesian(N,h);n.pack(g,u,3*p)}return u}(V,j,B,E,g,y,x,v),W=new Float32Array(3*(I=V.length));for(F=0;F<I;++F)W[3*F]=R[3*F]-v.x,W[3*F+1]=R[3*F+1]-v.y,W[3*F+2]=R[3*F+2]-v.z;let D=0,L=0;for(F=0;F<S;F++){let e=w[F]-1,t=.5*A[F],r=b[F],s=D;for(let a=0;a<e;a++){let i=n.unpack(W,D,O),o=n.unpack(W,D+3,P),d=B[L],f=B[L+1];d=l.lerp(g,y,d/32767),f=l.lerp(g,y,f/32767),L++;let h=H,c=U;if(0===a){let t=s+3*e,r=n.unpack(W,t,H);if(n.equals(r,i))n.unpack(W,t-3,h);else{let e=n.subtract(i,o,H);h=n.add(e,i,H)}}else n.unpack(W,D-3,h);if(a===e-1){let e=n.unpack(W,s,U);if(n.equals(e,o))n.unpack(W,s+3,c);else{let e=n.subtract(o,i,U);c=n.add(e,o,U)}}else n.unpack(W,D+6,c);C.addVolume(h,i,o,c,d,f,t,r,v,x),D+=3}D+=3,L++}let z=C.indices;d.push(C.startEllipsoidNormals.buffer),d.push(C.endEllipsoidNormals.buffer),d.push(C.startPositionAndHeights.buffer),d.push(C.startFaceNormalAndVertexCornerIds.buffer),d.push(C.endPositionAndHeights.buffer),d.push(C.endFaceNormalAndHalfWidths.buffer),d.push(C.vertexBatchIds.buffer),d.push(z.buffer);let Z={indexDatatype:2===z.BYTES_PER_ELEMENT?r.UNSIGNED_SHORT:r.UNSIGNED_INT,startEllipsoidNormals:C.startEllipsoidNormals.buffer,endEllipsoidNormals:C.endEllipsoidNormals.buffer,startPositionAndHeights:C.startPositionAndHeights.buffer,startFaceNormalAndVertexCornerIds:C.startFaceNormalAndVertexCornerIds.buffer,endPositionAndHeights:C.endPositionAndHeights.buffer,endFaceNormalAndHalfWidths:C.endFaceNormalAndHalfWidths.buffer,vertexBatchIds:C.vertexBatchIds.buffer,indices:z.buffer};if(e.keepDecodedPositions){let e=function(e){let t=e.length,r=new Uint32Array(t+1),s=0;for(let a=0;a<t;++a)r[a]=s,s+=e[a];return r[t]=s,r}(w);d.push(R.buffer,e.buffer),Z=s(Z,{decodedPositions:R.buffer,decodedPositionOffsets:e.buffer})}return Z});export{V as default};